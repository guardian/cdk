#!/usr/bin/env bash

set -e

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
ROOT_DIR=$DIR/..

installDependencies() {
  npm ci --ignore-scripts
}

updateAwsCdk() {
  npm run update-aws-cdk
}

installUpdatedDependencies() {
  npm install && cd tools/integration-test && npm install && cd "$ROOT_DIR"
}

checkForLocalChanges() {
  if git diff --quiet; then
    echo "No changes. No further action needed."
    exit 0
  fi
}

configureGit() {
  git config user.name "github-actions"
  git config user.email "github-actions@github.com"
}

raisePR() {
  LIBRARY_TO_CHECK="aws-cdk-lib"
  INSTALLED_VERSION_NUMBER=$(jq -r ".dependencies.\"${LIBRARY_TO_CHECK}\"" < "$DIR/../package.json")

  BRANCH_NAME="update-aws-cdk-$INSTALLED_VERSION_NUMBER"
  COMMIT_SUBJECT="fix(deps): Update ${LIBRARY_TO_CHECK} to $INSTALLED_VERSION_NUMBER"
  COMMIT_BODY="Update ${LIBRARY_TO_CHECK} to $INSTALLED_VERSION_NUMBER"

  git checkout -b "$BRANCH_NAME"

  for file in package.json package-lock.json tools/integration-test/package.json; do
    git add $file
  done

  git commit -m "$COMMIT_SUBJECT" -m "$COMMIT_BODY"

  git push -u origin "$BRANCH_NAME"
  gh pr create --title "$COMMIT_SUBJECT" --body "$COMMIT_BODY"
}

main() {
  installDependencies
  updateAwsCdk
  installUpdatedDependencies
  checkForLocalChanges
  configureGit
  raisePR
}

main
